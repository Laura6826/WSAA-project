<!--WSAA-project: Web Services and Applications.
This is a CRUD application for Cork City car parking data.
This HTML file provides a user interface for creating, reading, updating, and deleting car park data.
Author: Laura Lyons -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cork City Parking Checker</title>

    <!-- Bootstrap CSS -->
     <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-image: url('static/cork_city.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat; /* Prevents repetition */
            height: 100vh; /* Ensures the background covers the viewport height */
            margin: 0; /* Removes any default margin that might affect layout */
            color: white;
            text-shadow: 1px 1px 2px black;
        }        
        header {
            background: rgba(0, 0, 0, 0.5); /* Semi-transparent background for better contrast */
            padding: 20px;
            text-align: center;
            border-radius: 5px;
        }
        .content {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 20px;
            max-width: 800px;
            margin: 50px auto;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="content">
        <h1 class="text-center mb-4" style="color: rgb(199, 5, 5); ">Welcome to Cork City Parking Checker</h1>
        <h4 class="text-center mb-4" style="color: rgb(199, 5, 5); ">Check the availability of parking spaces in Cork City car parks.</h>
    </div>
    <div class="content">
        <!-- Current time display -->
        <div id="currentTimeDisplay" style="font-size: 1.2rem; color: black;">
            The time is now: <span id="currentTime"></span>
        </div>        
        
        <!-- Car park selection dropdown-->
        <div class="mt-4">
            <label for="carParkDropdown" class="form-label" style="color: black; " >Select Car Park to check availability: </label>
            <select id="carParkDropdown" class="form-select"></select>
        </div>

        <!-- Car park space availability -->
        <div class="mt-4 alert" id="checkFreeSpaces" role="alert" style="background-color: rgb(71, 195, 85); border: 2px solid rgb(0, 12, 2); border-radius: 8px; padding: 10px;">
            <label for="checkFreeSpaces" class="form-label" style="color: rgb(0, 3, 1); display: block; margin-bottom: 5px;">Parking space availability</label>
            <span id="freeSpacesContent" style="font-size: 1rem;"></span>
        </div>        

        <!-- Car park opening hours -->
        <div class="mt-4 alert alert-info" id="openingHoursResult" role="alert" style="background-color: lightblue; border: 2px solid blue; border-radius: 8px; padding: 10px;">
            <label for="openingHoursResult" class="form-label" style="color: rgb(0, 0, 11); display: block; margin-bottom: 5px;">Car park opening hours</label>
            <!-- Dynamic opening hours content will appear here -->
            <span id="openingHoursContent"></span>
        </div>

        <!-- Car park height restrictions -->
        <div class="mt-4 alert alert-danger" id="heightRestrictionNotice" role="alert" style="background-color: rgb(217, 94, 94); border: 2px solid rgb(134, 9, 9); border-radius: 8px; padding: 10px;">
            <label for="heightRestrictionNotice" class="form-label" style="color: rgb(3, 0, 0); display: block; margin-bottom: 5px;">Height restrictions</label>
            <!-- Content for height restrictions will go here -->
            <span id="heightRestrictionContent"></span>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        // Car Park Data
        const heightRestrictions = {
            "Black Ash Park & Ride": 2.1,
            "North Main Street": 2.0,
            "City Hall - Eglington Street": 2.0,
            "Carrolls Quay": 2.0,
            "Saint Finbarr's": 2.0,
            "Paul Street": 2.0,
            "Merchants Quay": 1.98,
            "Grand Parade": 1.85
        };

        const carParkDetails = {
            "Black Ash Park & Ride": { 
                height: 2.1, 
                schedule: {
                    "Monday": { openingTime: "06:45", closingTime: "20:00" },
                    "Tuesday": { openingTime: "06:45", closingTime: "20:00" },
                    "Wednesday": { openingTime: "06:45", closingTime: "20:00" },
                    "Thursday": { openingTime: "06:45", closingTime: "20:00" },
                    "Friday": { openingTime: "06:45", closingTime: "20:00" },
                    "Saturday": { openingTime: "06:45", closingTime: "20:00" },
                    "Sunday": { status: "Closed" } // Specify closed status for Sunday
                }
            },
            "North Main Street": { 
                height: 2.0, 
                schedule: {
                    "Monday": { openingTime: "07:30", closingTime: "21:30" },
                    "Tuesday": { openingTime: "07:30", closingTime: "21:30" },
                    "Wednesday": { openingTime: "07:30", closingTime: "21:30" },
                    "Thursday": { openingTime: "07:30", closingTime: "21:30" },
                    "Friday": { openingTime: "07:30", closingTime: "21:30" },
                    "Saturday": { openingTime: "07:30", closingTime: "21:30" },
                    "Sunday": { status: "Closed" } 
                }
            },

            "Merchants Quay": { 
                height: 2.0, 
                schedule: {
                    "Monday": { openingTime: "08:00", closingTime: "19:00" },
                    "Tuesday": { openingTime: "08:00", closingTime: "19:00" },
                    "Wednesday": { openingTime: "08:00", closingTime: "19:00" },
                    "Thursday": { openingTime: "08:00", closingTime: "19:00" },
                    "Friday": { openingTime: "08:00", closingTime: "21:00" },
                    "Saturday": { openingTime: "08:00", closingTime: "19:00" },
                    "Sunday": { openingTime: "12:00", closingTime: "18:30" }
                }
            },

            "City Hall - Eglington Street": { 
                height: 2.0, 
                schedule: {
                    "Monday": { status: "24 Hours" },
                    "Tuesday": { status: "24 Hours" },
                    "Wednesday": { status: "24 Hours" },
                    "Thursday": { status: "24 Hours" },
                    "Friday": { status: "24 Hours" },
                    "Saturday": { status: "24 Hours" },
                    "Sunday": { status: "24 Hours" }
                }
            },

            "Carrolls Quay": { 
                height: 2.0, 
                schedule: {
                    "Monday": { status: "24 Hours" },
                    "Tuesday": { status: "24 Hours" },
                    "Wednesday": { status: "24 Hours" },
                    "Thursday": { status: "24 Hours" },
                    "Friday": { status: "24 Hours" },
                    "Saturday": { status: "24 Hours" },
                    "Sunday": { status: "24 Hours" }
                }
            },

            "Saint Finbarr's": { 
                height: 2.0, 
                schedule: {
                    "Monday": { status: "24 Hours" },
                    "Tuesday": { status: "24 Hours" },
                    "Wednesday": { status: "24 Hours" },
                    "Thursday": { status: "24 Hours" },
                    "Friday": { status: "24 Hours" },
                    "Saturday": { status: "24 Hours" },
                    "Sunday": { status: "24 Hours" }
                }
            },

            "Grand Parade": { 
                height: 1.85, 
                schedule: {
                    "Monday": { status: "24 Hours" },
                    "Tuesday": { status: "24 Hours" },
                    "Wednesday": { status: "24 Hours" },
                    "Thursday": { status: "24 Hours" },
                    "Friday": { status: "24 Hours" },
                    "Saturday": { status: "24 Hours" },
                    "Sunday": { status: "24 Hours" }
                }
            },

            "Paul Street": { 
                height: 2.0, 
                schedule: {
                    "Monday": { status: "24 Hours" },
                    "Tuesday": { status: "24 Hours" },
                    "Wednesday": { status: "24 Hours" },
                    "Thursday": { status: "24 Hours" },
                    "Friday": { status: "24 Hours" },
                    "Saturday": { status: "24 Hours" },
                    "Sunday": { status: "24 Hours" }
                }
            },
        };

        // Function to set and display the current time
        function updateCurrentTime() {
            const now = new Date(); // Get the current date and time
            const hours = String(now.getHours()).padStart(2, '0'); // Format hours (24-hour format)
            const minutes = String(now.getMinutes()).padStart(2, '0'); // Format minutes
            const seconds = String(now.getSeconds()).padStart(2, '0'); // Format seconds
            const formattedTime = `${hours}:${minutes}:${seconds}`; // Combine into a time string
            document.getElementById('currentTime').innerText = formattedTime; // Update the content of span
        }

        // Call the function immediately and then every second
        updateCurrentTime(); // Initialize the time display
        setInterval(updateCurrentTime, 1000); // Update every second

        // Populate dropdown menu with car park options
        async function populateDropdown() {
            const parkingData = await fetchParkingData(); // Get data from the live API
            const dropdown = document.getElementById("carParkDropdown");

            // Clear previous dropdown options
            dropdown.innerHTML = '<option value="">Select Car Park</option>';

            parkingData.forEach(park => {
                const option = document.createElement("option");
                option.value = park.name || "Unknown";
                option.dataset.freeSpaces = park.free_spaces || "0"; // Dynamically set free spaces
                option.innerText = park.name || "Unnamed Car Park";
                dropdown.appendChild(option);
            });
        }

        // Fetch parking data from the server
        async function fetchParkingData() {
            try {
                const response = await fetch("/api/fetch"); // Replace "/api/fetch" with the actual endpoint of your API
                if (!response.ok) {
                    throw new Error(`Server Error: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                console.log("Fetched parking data:", data); // Debug: Log the API response
                return data;
            } catch (error) {
                console.error("Error fetching parking data:", error);
                return [];
            }
        }

        // Check if the car park has free spaces
        function checkFreeSpaces() {
            const dropdown = document.getElementById("carParkDropdown");
            const selectedOption = dropdown.options[dropdown.selectedIndex];

            // Log the selected option and its data to the console
            console.log("Selected option:", selectedOption);
            console.log("Selected option data-freeSpaces:", selectedOption.dataset.freeSpaces);

            const freeSpaces = parseInt(selectedOption.freeSpaces) || 0;
            const resultContainer = document.getElementById("checkFreeSpaces");

            if (freeSpaces > 0) {
                resultContainer.innerText = `Yes, there are ${freeSpaces} free spaces available.`;
                resultContainer.className = "alert alert-success mt-3"; // Ensure the alert box is visible
            } else {
                resultContainer.innerText = "No, the car park is full.";
                resultContainer.className = "alert alert-danger mt-3"; // Ensure the alert box is visible
            }
        }
    
        // Get Current Day Name
        function getCurrentDayName() {
            const dayIndex = new Date().getDay(); // 0 = Sunday, 1 = Monday, etc.
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            return days[dayIndex];
        }
            
        // Function to set and display the current time
        function setCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0'); // Add leading zero for hours
            const minutes = String(now.getMinutes()).padStart(2, '0'); // Add leading zero for minutes
            const currentTime = `${hours}:${minutes}`; // Format: HH:MM
            document.getElementById("currentTime").innerText = currentTime; // Update the time display
        }

        // Initialize and update the current time on page load
        window.onload = function() {
            setCurrentTime(); // Set the current time initially
            setInterval(setCurrentTime, 60000); // Update every minute
        };


        function handleCarParkSchedule(scheduleForToday, freeSpaces, selectedOption) {
            const resultContainer = document.getElementById("carParkInfoResult");
            const now = new Date();

            if (scheduleForToday?.status === "24 Hours") {
                resultContainer.innerHTML = `
                    <strong>${selectedOption.value}:</strong> Open 24 hours today.<br>
                    Free spaces: ${freeSpaces}.
                `;
                resultContainer.classList.add("alert-success");
                return;
            }

            const closingTime = scheduleForToday?.closingTime || "N/A";
            const [closingHours, closingMinutes] = closingTime.split(":").map(Number);
            const minutesUntilClosing = (closingHours * 60 + closingMinutes) - (now.getHours() * 60 + now.getMinutes());

            if (minutesUntilClosing <= 0) {
                resultContainer.innerHTML = `
                    <strong>${selectedOption.value}:</strong> Already closed.<br>
                    Free spaces: ${freeSpaces}.
                `;
                resultContainer.classList.add("alert-danger");
            } else if (minutesUntilClosing <= 60) {
                resultContainer.innerHTML = `
                    <strong>${selectedOption.value}:</strong> Closes in ${minutesUntilClosing} minutes.<br>
                    Free spaces: ${freeSpaces}.
                `;
                resultContainer.classList.add("alert-warning");
            } else {
                resultContainer.innerHTML = `
                    <strong>${selectedOption.value}:</strong> Closes at ${closingTime} today.<br>
                    Free spaces: ${freeSpaces}.
                `;
                resultContainer.classList.add("alert-info");
            }
        }

        // Display car park details: opening hours and height restriction
        function displayCarParkInfo() {
            const dropdown = document.getElementById("carParkDropdown");
            const selectedCarPark = carParkDetails[dropdown.value];
            const openingHoursResult = document.getElementById("openingHoursResult");
            const heightRestrictionNotice = document.getElementById("heightRestrictionNotice");
            const currentDay = getCurrentDayName();

            if (selectedCarPark) {
                // Display opening hours
                const scheduleForToday = selectedCarPark.schedule[currentDay];
                if (scheduleForToday && scheduleForToday.status === "Closed") {
                    openingHoursResult.innerHTML = `<strong>${dropdown.value}:</strong> Closed today.`;
                    openingHoursResult.className = "alert alert-warning";
                } else {
                    const openingTime = scheduleForToday?.openingTime || "N/A";
                    const closingTime = scheduleForToday?.closingTime || "N/A";
                    openingHoursResult.innerHTML = `<strong>${dropdown.value}:</strong> Open from ${openingTime} to ${closingTime}.`;
                    openingHoursResult.className = "alert alert-info";
                }

                // Display height restriction
                heightRestrictionNotice.innerHTML = `<strong>Important Notice:</strong> Height restriction for this car park is ${selectedCarPark.height} meters.`;
                heightRestrictionNotice.className = "alert alert-danger";
            } else {
                // Handle invalid selection
                openingHoursResult.innerHTML = "Please select a valid car park.";
                openingHoursResult.className = "alert alert-warning";
                heightRestrictionNotice.innerHTML = ""; // Clear height restriction notice
            }
        }

        // Initialize dropdown and attach event listener
        window.onload = function () {
            populateDropdown();
            document.getElementById("carParkDropdown").addEventListener("change", displayCarParkInfo);
        };
        // Attach event listener to dropdown for checking free spaces
        document.getElementById("carParkDropdown").addEventListener("change", function() {
            const selectedOption = this.options[this.selectedIndex];
            const freeSpaces = parseInt(selectedOption.dataset.freeSpaces) || 0;
            checkFreeSpaces(freeSpaces); // Pass the free spaces to the function
            displayCarParkInfo(); // Call the function to display car park info
        });

    </script>
</body>
</html>

