<!--WSAA-project: Web Services and Applications.
This is a CRUD application for Cork City car parking data.
This HTML file provides a user interface for creating, reading, updating, and deleting car park data.
Author: Laura Lyons -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parking Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center">Parking Management Interface</h1>

        <!-- Section: Select Parking Location -->
        <div class="mb-4">
            <h5>Select Car Park by Name</h5>
            <select id="carParkDropdown" class="form-select">
                <!-- Car parks will be dynamically added here -->
            </select>
            <button id="showCarPark" class="btn btn-primary mt-3">Check Car Park Details</button>
            <div id="carParkResult" class="mt-3"></div>
        </div>

        <!-- Section: Enter Vehicle Details -->
        <div class="mb-4">
            <h5>Vehicle Height Check</h5>
            <form id="heightCheckForm">
                <div class="row mb-2">
                    <div class="col">
                        <input type="number" step="0.01" id="vehicleHeight" class="form-control" placeholder="Your Vehicle Height (meters)" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">Check Compatibility</button>
            </form>
            <div id="heightCheckResult" class="mt-3"></div>
        </div>

        <!-- Section: Enter Parking Time Details -->
        <div class="mb-4">
            <h5>Calculate Parking Cost</h5>
            <form id="parkingCostForm">
                <div class="row mb-2">
                    <div class="col">
                        <input type="time" id="startTime" class="form-control" placeholder="Start Time" required>
                    </div>
                    <div class="col">
                        <input type="time" id="endTime" class="form-control" placeholder="End Time" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-warning">Calculate Cost</button>
            </form>
            <div id="parkingCostResult" class="mt-3"></div>
        </div>

        <!-- Section: Fetch Parking Data -->
        <div class="mb-4">
            <button id="fetchData" class="btn btn-primary">Fetch Parking Data</button>
            <div id="fetchResult" class="mt-3"></div>
        </div>
    </div>

    <script>
        // Populate dropdown with car park names
        function populateDropdown() {
            $.get("/api/parking", function(data) {
                const dropdown = $("#carParkDropdown");
                dropdown.empty();
                data.forEach(parking => {
                    dropdown.append(`<option value="${parking.parking_name}">${parking.parking_name}</option>`);
                });
            }).fail(function(error) {
                $("#carParkResult").html("<pre>Error: " + JSON.stringify(error.responseJSON, null, 2) + "</pre>");
            });
        }

        // Show car park details
        $("#showCarPark").click(function() {
            const selectedCarPark = $("#carParkDropdown").val();
            $.get("/api/parking", function(data) {
                const result = data.find(parking => parking.parking_name === selectedCarPark);

                if (result) {
                    const currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const openingTimes = result.opening_times.split(" to ");
                    const isOpen = currentTime >= openingTimes[0] && currentTime <= openingTimes[1];

                    let statusMessage = isOpen ? "Open" : "Closed";
                    if (result.spaces_available > result.free_spaces) {
                        $("#carParkResult").html(`<p>Car Park Status: ${statusMessage}</p>
                        <p>Free Spaces: ${result.free_spaces}</p>
                        <p>Height Restriction: ${result.height_restriction}</p>
                        <p>Price Rates: ${result.prices_rates}</p>`);
                    } else {
                        $("#carParkResult").html("<p>Sorry, no spaces are available!</p>");
                    }
                } else {
                    $("#carParkResult").html("<p>No data found for the selected car park.</p>");
                }
            }).fail(function(error) {
                $("#carParkResult").html("<pre>Error: " + JSON.stringify(error.responseJSON, null, 2) + "</pre>");
            });
        });

        // Check vehicle height compatibility
        $("#heightCheckForm").submit(function(e) {
            e.preventDefault();
            const selectedCarPark = $("#carParkDropdown").val();
            const vehicleHeight = parseFloat($("#vehicleHeight").val());

            $.get("/api/parking", function(data) {
                const result = data.find(parking => parking.parking_name === selectedCarPark);
                if (result) {
                    const heightRestriction = parseFloat(result.height_restriction);
                    if (vehicleHeight <= heightRestriction) {
                        $("#heightCheckResult").html("<p>Your vehicle can fit in this car park!</p>");
                    } else {
                        $("#heightCheckResult").html("<p>Your vehicle exceeds the height restriction!</p>");
                    }
                } else {
                    $("#heightCheckResult").html("<p>No data found for the selected car park.</p>");
                }
            }).fail(function(error) {
                $("#heightCheckResult").html("<pre>Error: " + JSON.stringify(error.responseJSON, null, 2) + "</pre>");
            });
        });

        // Calculate parking cost
        $("#parkingCostForm").submit(function(e) {
            e.preventDefault();
            const selectedCarPark = $("#carParkDropdown").val();
            const startTime = $("#startTime").val();
            const endTime = $("#endTime").val();

            $.get("/api/parking", function(data) {
                const result = data.find(parking => parking.parking_name === selectedCarPark);
                if (result) {
                    const priceRates = parseFloat(result.prices_rates.replace("€/hour", ""));
                    const start = new Date(`1970-01-01T${startTime}:00`);
                    const end = new Date(`1970-01-01T${endTime}:00`);
                    const hours = Math.abs(end - start) / 36e5;

                    const cost = hours * priceRates;
                    $("#parkingCostResult").html(`<p>Total Parking Cost: €${cost.toFixed(2)}</p>`);
                } else {
                    $("#parkingCostResult").html("<p>No data found for the selected car park.</p>");
                }
            }).fail(function(error) {
                $("#parkingCostResult").html("<pre>Error: " + JSON.stringify(error.responseJSON, null, 2) + "</pre>");
            });
        });

        // Fetch parking data and populate dropdown
        $("#fetchData").click(function() {
            $.get("/api/fetch", function(data) {
                $("#fetchResult").html("<pre>" + JSON.stringify(data, null, 2) + "</pre>");
                populateDropdown(); // Refresh dropdown with updated data
            }).fail(function(error) {
                $("#fetchResult").html("<pre>Error: " + JSON.stringify(error.responseJSON, null, 2) + "</pre>");
            });
        });

        // Initial population of dropdown on page load
        $(document).ready(function() {
            populateDropdown();
        });
    </script>
</body>
</html>
